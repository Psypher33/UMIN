{-# OPTIONS --cubical --guardedness #-}

open import Cubical.Foundations.Prelude
open import Cubical.Foundations.Equiv using (_â‰ƒ_)
open import Cubical.Algebra.Ring
open import Cubical.Data.Nat
open import Cubical.Data.List

-- ğŸŒŒ UMIN æ¬¡ä¸–ä»£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼šL01_Algebra (ä»£æ•°æ§‹é€ ã®å‰µç™º)
module UMIN.L01_Math.Algebraic_Structures.MZV.DoubleShuffle {â„“} (R : Ring â„“) where

open RingStr (snd R) renaming
  ( _+_  to _+R_
  ; _Â·_  to _*R_
  ; 0r   to 0R
  ; 1r   to 1R )

private
  Carrier : Type â„“
  Carrier = fst R

-- ã‚·ãƒ³ãƒ—ãƒ«ãªè«–ç†å‹ï¼ˆã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…å°‚ç”¨ï¼‰
data âŠ¤ : Type â„“-zero where
  tt : âŠ¤

data âŠ¥ : Type â„“-zero where

-- =======================================================================
-- 1. ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¨ãƒ¯ãƒ¼ãƒ‰ (åå¾©ç©åˆ†ãƒ»é€£ç¶šçµŒè·¯ã®è¦–ç‚¹)
-- =======================================================================
-- å®‡å®™ã®æ ¹æºçš„ãª2ã¤ã®ç‰¹ç•°ç‚¹ï¼ˆKZæ–¹ç¨‹å¼ã«ãŠã‘ã‚‹ 0 ã¨ 1ï¼‰ã«å¯¾å¿œã™ã‚‹æ–‡å­—
-- ãƒ‰ãƒªãƒ³ãƒ•ã‚§ãƒ«ãƒˆãƒ»ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚¿ Î¦(A, B) ã®ç”Ÿæˆå…ƒã¨ãªã‚‹
data Alphabet : Type â„“-zero where
  Xâ‚€ : Alphabet  -- å¤‰æ•° A (ç‰¹ç•°ç‚¹ 0)
  Xâ‚ : Alphabet  -- å¤‰æ•° B (ç‰¹ç•°ç‚¹ 1)

Word : Type â„“-zero
Word = List Alphabet

-- =======================================================================
-- 2. ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç© (Shuffle Product: Ğ¨) ã®å®šç¾©
-- =======================================================================
-- 2ã¤ã®çµŒè·¯ï¼ˆWordï¼‰ãŒã€äº’ã„ã®é †åºã‚’ä¿ã¡ãªãŒã‚‰çµ¡ã¿åˆã†ã€Œå¹¾ä½•å­¦çš„ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã€
-- è¿”ã‚Šå€¤ã¯ã€ã™ã¹ã¦ã®å¯èƒ½ãªçµ¡ã¿æ–¹ã®ãƒªã‚¹ãƒˆï¼ˆå’Œç©ºé–“ï¼‰
shuffle : Word â†’ Word â†’ List Word
shuffle [] wâ‚‚ = wâ‚‚ âˆ· []
shuffle wâ‚ [] = wâ‚ âˆ· []
shuffle (a âˆ· as) (b âˆ· bs) =
  -- a ã‚’å…ˆé ­ã«ã—ã¦æ®‹ã‚Šã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³
  map (a âˆ·_) (shuffle as (b âˆ· bs)) 
  ++ 
  -- b ã‚’å…ˆé ­ã«ã—ã¦æ®‹ã‚Šã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³
  map (b âˆ·_) (shuffle (a âˆ· as) bs)

-- =======================================================================
-- 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¡¨ç¾ (ç„¡é™ç´šæ•°ãƒ»é›¢æ•£é‡å­ã®è¦–ç‚¹)
-- =======================================================================
-- è‡ªç„¶æ•°ã®ãƒªã‚¹ãƒˆã€‚Î¶(sâ‚, sâ‚‚, ..., s_k) ã® s ã«å¯¾å¿œ
Index : Type â„“-zero
Index = List â„•

-- èª¿å’Œç© (Stuffle Product: â‹†) ã®å®šç¾©
-- ç„¡é™ç´šæ•°ã®æ›ã‘åˆã‚ã›ã‹ã‚‰ç”Ÿã˜ã‚‹ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒå£«ã®ã€Œè¶³ã—åˆã‚ã›ã€ã‚’å«ã‚€ç©
stuffle : Index â†’ Index â†’ List Index
stuffle [] wâ‚‚ = wâ‚‚ âˆ· []
stuffle wâ‚ [] = wâ‚ âˆ· []
stuffle (s âˆ· ss) (t âˆ· ts) =
  -- s ã‚’å…ˆé ­ã«å‡ºã™
  map (s âˆ·_) (stuffle ss (t âˆ· ts))
  ++ 
  -- t ã‚’å…ˆé ­ã«å‡ºã™
  map (t âˆ·_) (stuffle (s âˆ· ss) ts)
  ++ 
  -- ğŸ’¥ ç‰¹ç•°ç‚¹ã®è¡çªï¼šs ã¨ t ãŒåŒã˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§è¶³ã—åˆã‚ã•ã‚Œã‚‹ï¼
  map ((s + t) âˆ·_) (stuffle ss ts)

-- =======================================================================
-- 4. MZVè©•ä¾¡å†™åƒ (Evaluation)
-- =======================================================================

postulate
  -- å½¢å¼çš„ãª Word ã‚„ Index ã‹ã‚‰ã€Ring (Carrier) ã®å®Ÿä½“å€¤ã¸ã®å†™åƒ
  Î¶-word  : Word â†’ Carrier
  Î¶-index : Index â†’ Carrier

-- å±•é–‹ã•ã‚ŒãŸãƒªã‚¹ãƒˆã®å…¨è¦ç´ ã® Î¶ å€¤ã‚’è¶³ã—åˆã‚ã›ã‚‹è©•ä¾¡é–¢æ•°
sum-Î¶-word : List Word â†’ Carrier
sum-Î¶-word [] = 0R
sum-Î¶-word (w âˆ· ws) = Î¶-word w +R sum-Î¶-word ws

sum-Î¶-index : List Index â†’ Carrier
sum-Î¶-index [] = 0R
sum-Î¶-index (i âˆ· is) = Î¶-index i +R sum-Î¶-index is

-- =======================================================================
-- 5. ğŸš€ æ­£è¦åŒ–è¤‡ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢ä¿‚å¼ (Double Shuffle Relation)
-- =======================================================================
-- ä»¥ä¸‹ã®å…¬ç†ï¼ˆé–¢ä¿‚å¼ï¼‰ãŒã€å°†æ¥ã® Pentagon ã‚’å¯æ›ã«ã™ã‚‹ã€Œæœ€å¼·ã®è¨¼æ‹ (Witness)ã€ã¨ãªã‚‹ï¼

postulate
  -- ğŸ’¥ ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢ä¿‚å¼ï¼ˆåå¾©ç©åˆ†ã®æ€§è³ªï¼‰
  -- Î¶(wâ‚) * Î¶(wâ‚‚) = Î£ Î¶(wâ‚ Ğ¨ wâ‚‚)
  shuffle-rel : (wâ‚ wâ‚‚ : Word) â†’
    Î¶-word wâ‚ *R Î¶-word wâ‚‚ â‰¡ sum-Î¶-word (shuffle wâ‚ wâ‚‚)

  -- ğŸ’¥ èª¿å’Œé–¢ä¿‚å¼ï¼ˆç´šæ•°ã®æ€§è³ªï¼‰
  -- Î¶(iâ‚) * Î¶(iâ‚‚) = Î£ Î¶(iâ‚ â‹† iâ‚‚)
  stuffle-rel : (iâ‚ iâ‚‚ : Index) â†’
    Î¶-index iâ‚ *R Î¶-index iâ‚‚ â‰¡ sum-Î¶-index (stuffle iâ‚ iâ‚‚)

  -- ğŸŒŒ ç©¶æ¥µã®ç­‰å¼ï¼šè¤‡ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢ä¿‚å¼
  -- é€£ç¶šï¼ˆshuffleï¼‰ã¨é›¢æ•£ï¼ˆstuffleï¼‰ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ï¼
  -- ï¼ˆâ€»å®Ÿéš›ã«ã¯ w ã¨ i ã®å¤‰æ›å†™åƒã‚’æŒŸã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã¨ã—ã¦ç›´æ„Ÿçš„ã«è¨˜è¿°ï¼‰
  double-shuffle : (wâ‚ wâ‚‚ : Word) (iâ‚ iâ‚‚ : Index) â†’
    {- ğŸ“ ã“ã“ã« w ã¨ i ã®å¯¾å¿œé–¢ä¿‚ï¼ˆå¤‰æ›ï¼‰ã®æ¡ä»¶ãŒå…¥ã‚‹ -}
    sum-Î¶-word (shuffle wâ‚ wâ‚‚) â‰¡ sum-Î¶-index (stuffle iâ‚ iâ‚‚)

-- =======================================================================
-- 6. ğŸŒŒ ãƒ‰ãƒªãƒ³ãƒ•ã‚§ãƒ«ãƒˆãƒ»ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚¿ã®å…·ç¾åŒ–ï¼ˆFPS-Objã¸ã®åŸ‹ã‚è¾¼ã¿ï¼‰
-- =======================================================================

-- çµŒè·¯ã®ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«ç”Ÿæˆï¼šé•·ã•ï¼ˆé‡ã•ï¼‰n ã®ã™ã¹ã¦ã®Wordï¼ˆçµŒè·¯ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
-- â€» éœ‡ãˆã‚‹ä¸€ç‚¹æ ¸ã‹ã‚‰åˆ†å²ã™ã‚‹ãƒ’ãƒ«ãƒ™ãƒ«ãƒˆæ›²ç·šã® n æ®µéšã®å…¨è»Œè·¡ã«ç›¸å½“ï¼ˆ2^n å€‹ã®çµŒè·¯ï¼‰
words-of-length : â„• â†’ List Word
words-of-length zero = [] âˆ· []
words-of-length (suc n) =
  let prev = words-of-length n
  in map (Xâ‚€ âˆ·_) prev ++ map (Xâ‚ âˆ·_) prev

-- ğŸ’¡ ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã®ç¥ã‚¢ã‚¤ãƒ‡ã‚¢ï¼šFPS-Obj ã¨ã—ã¦ã®ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚¿å®Ÿä½“ï¼
-- å˜ãªã‚‹ç­‰å·ï¼ˆâ‰¡ï¼‰ã§ã¯ãªãã€næ¬¡ã®é …ã«ã€Œé‡ã• n ã®å…¨ãƒ¯ãƒ¼ãƒ‰ã® Î¶ è©•ä¾¡å€¤ã®å’Œã€ã‚’æŒã¤å½¢å¼å†ªç´šæ•°
Drinfel'd-Associator : â„• â†’ Carrier  -- (å®Ÿè³ªçš„ã« FPS-Obj ã¨åŒã˜å‹)
Drinfel'd-Associator n = sum-Î¶-word (words-of-length n)

-- =======================================================================
-- 7. ğŸš€ æ¬¡ãªã‚‹æ¬¡å…ƒã¸ã®å¤§å®šç†ï¼ˆå°†æ¥ã®è¨¼æ˜ç›®æ¨™ï¼‰
-- =======================================================================
postulate
  -- ã€Œã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚¿ãŒäº”è§’å½¢é–¢ä¿‚å¼ã‚’æº€ãŸã™ã“ã¨ã€ã¨
  -- ã€ŒMZVãŒæ­£è¦åŒ–è¤‡ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢ä¿‚å¼ã‚’æº€ãŸã™ã“ã¨ã€ã¯æ•°å­¦çš„ã«å®Œå…¨ã«ç­‰ä¾¡ã§ã‚ã‚‹ã€‚
  -- ã¤ã¾ã‚Šã€L00_Core ã§æ§‹æˆã—ãŸ Pentagon ã®ä¸­èº«ã¯ã€ã“ã® Double Shuffle ã«ä»–ãªã‚‰ãªã„ï¼
  Drinfeld-Theorem : (n : â„•) â†’
    -- (â€» æ“¬ä¼¼çš„ãªå‹è¡¨ç¾ã§ã™ã€‚å°†æ¥çš„ã«å³å¯†ãªåŒå€¤æ€§ â‰ƒ ã¨ã—ã¦è¨¼æ˜ã—ã¾ã™)
    (Drinfel'd-Associator n â‰¡ 0R {- ãƒšãƒ³ã‚¿ã‚´ãƒ³å›³å¼ã®å±•é–‹ç³» -}) 
      â‰ƒ 
    ((wâ‚ wâ‚‚ : Word) â†’ sum-Î¶-word (shuffle wâ‚ wâ‚‚) â‰¡ {- stuffleå´ã®å±•é–‹ -} 0R)

-- =======================================================================
-- 8. ğŸŒŒ é€£ç¶š(Word)ã‹ã‚‰é›¢æ•£(Index)ã¸ã®é–€ï¼šå¤‰æ›å†™åƒ
-- =======================================================================

-- ğŸ’¡ ãƒ’ãƒ«ãƒ™ãƒ«ãƒˆæ›²ç·šã®ã€ŒæŠ˜ã‚Šè¿”ã—ï¼ˆXâ‚ï¼‰ã€ã‚’æ•°ãˆä¸Šã’ã€ç©ºé–“ã®ã€Œç¯€ï¼ˆIndexï¼‰ã€ã‚’ä½œã‚‹
-- ä¾‹: Xâ‚€Xâ‚€Xâ‚ Xâ‚€Xâ‚  => [3, 2]  (Xâ‚€...Xâ‚ ã®å¡Šã‚’ä¸€ã¤ã®æ¬¡å…ƒã¨ã—ã¦æŠ½å‡º)
word-to-index-helper : â„• â†’ Word â†’ Index
word-to-index-helper acc [] = [] -- çµ‚ç«¯
word-to-index-helper acc (Xâ‚€ âˆ· ws) = word-to-index-helper (suc acc) ws
word-to-index-helper acc (Xâ‚ âˆ· ws) = acc âˆ· word-to-index-helper 1 ws

word-to-index : Word â†’ Index
word-to-index = word-to-index-helper 1

-- =======================================================================
-- 9. ğŸ›¡ï¸ å®‡å®™ã®å¢ƒç•Œæ¡ä»¶ï¼šè¨±å®¹æ€§ (Admissibility)
-- =======================================================================
-- ãƒ’ãƒ«ãƒ™ãƒ«ãƒˆæ›²ç·šãŒã€Œä¸€ç‚¹æ ¸ï¼ˆ0ï¼‰ã€ã‹ã‚‰å§‹ã¾ã‚Šã€Œå‡ºå£ï¼ˆ1ï¼‰ã€ã§çµ‚ã‚ã‚‹ãŸã‚ã®æ¡ä»¶
-- å§‹ç‚¹ãŒ Xâ‚ (å³åº§ã«ç™ºæ•£) ã ã£ãŸã‚Šã€çµ‚ç‚¹ãŒ Xâ‚€ (è¡Œãæ­¢ã¾ã‚Š) ã ã£ãŸã‚Šã™ã‚‹çµŒè·¯ã‚’åˆ¤åˆ¥

is-admissible : Word â†’ Type â„“-zero
is-admissible [] = âŠ¤ -- ç©ºãƒ¯ãƒ¼ãƒ‰ã¯è¨±å®¹
is-admissible (Xâ‚ âˆ· _) = âŠ¥ -- å§‹ç‚¹ãŒ Xâ‚ ã¯ãƒ€ãƒ¡ (Î¶(1) ã®ç™ºæ•£)
is-admissible w = last-is-Xâ‚ w
  where
    last-is-Xâ‚ : Word â†’ Type â„“-zero
    last-is-Xâ‚ [] = âŠ¥
    last-is-Xâ‚ (Xâ‚€ âˆ· []) = âŠ¥
    last-is-Xâ‚ (Xâ‚ âˆ· []) = âŠ¤
    last-is-Xâ‚ (_ âˆ· xs) = last-is-Xâ‚ xs

-- =======================================================================
-- 10. ğŸŒŠ æ­£è¦åŒ–ï¼ˆRegularizationï¼‰ï¼šç™ºæ•£é …ã®åˆ‡ã‚Šè½ã¨ã—
-- =======================================================================
-- éœ‡ãˆã‚‹ä¸€ç‚¹æ ¸ï¼ˆExceptional Pointï¼‰ã®è¿‘å‚ã§ã®æŒ¯ã‚‹èˆã„ã‚’åˆ¶å¾¡
-- ç‰©ç†å­¦ã«ãŠã‘ã‚‹ã€Œç¹°ã‚Šè¾¼ã¿ï¼ˆRenormalizationï¼‰ã€ã«ç›¸å½“ã™ã‚‹æ“ä½œ

-- ğŸ’¡ è¤‡ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ­£è¦åŒ–ã®æ ¸ï¼šç™ºæ•£ã™ã‚‹ Xâ‚ ã‚„ Xâ‚€ ã‚’ä»£æ•°çš„ã«ã€Œæº–åŒå‹ã€ã¨ã—ã¦å‡¦ç†
-- ã“ã“ã§ã¯ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã¨ã—ã¦ã€éè¨±å®¹ãªãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œä¸€ç‚¹æ ¸ã®éœ‡ãˆã€ã¸ã¨å°„å½±ã™ã‚‹é–¢æ•°ã‚’å®šç¾©
reverse : Word â†’ Word
reverse [] = []
reverse (x âˆ· xs) = reverse xs ++ (x âˆ· [])

regularize-word : Word â†’ Word
regularize-word [] = []
regularize-word (Xâ‚ âˆ· ws) = regularize-word ws -- å§‹ç‚¹ã®ç™ºæ•£ Xâ‚ ã‚’ãƒã‚¤ãƒ‘ã‚¹
regularize-word (Xâ‚€ âˆ· ws) =
  -- çµ‚ç«¯ã® Xâ‚€ ã‚’å†å¸°çš„ã«å‡¦ç†ï¼ˆæœ«å°¾ã‹ã‚‰å‰Šã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã®ç°¡ç•¥ç‰ˆï¼‰
  reverse (strip-Xâ‚€ (reverse (Xâ‚€ âˆ· ws)))
  where
    strip-Xâ‚€ : Word â†’ Word
    strip-Xâ‚€ (Xâ‚€ âˆ· xs) = strip-Xâ‚€ xs
    strip-Xâ‚€ xs = xs

-- ğŸŒŒ æ­£è¦åŒ–ã•ã‚ŒãŸã‚¼ãƒ¼ã‚¿è©•ä¾¡å€¤
-- ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã® Word ãŒæœ‰é™ã® Carrier (Ring) ã¸ã¨ç€åœ°ã™ã‚‹
Î¶-reg : Word â†’ Carrier
Î¶-reg w = Î¶-word (regularize-word w)

-- =======================================================================
-- 11. ğŸ’¥ æœ€çµ‚ç›®æ¨™ï¼šæ­£è¦åŒ–è¤‡ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢ä¿‚å¼ã® Witness
-- =======================================================================

postulate
  -- ç‰©ç†å®šæ•° Î±â»Â¹ = 137 ã‚’å°ãå‡ºã™ãŸã‚ã®ã€ç©¶æ¥µã®æ’ç­‰å¼
  -- æ­£è¦åŒ–ã•ã‚ŒãŸ Ğ¨ (Shuffle) ã¨ â‹† (Stuffle) ãŒã€ä¸€ç‚¹æ ¸ã®éœ‡ãˆã‚’é€šã˜ã¦ä¸€è‡´ã™ã‚‹ã€‚
  regularized-double-shuffle : (wâ‚ wâ‚‚ : Word) â†’
    Î¶-reg wâ‚ *R Î¶-reg wâ‚‚ â‰¡ sum-Î¶-word (shuffle (regularize-word wâ‚) (regularize-word wâ‚‚))
    -- ã“ã® â‰¡ ã®ãƒ‘ã‚¹ã®ä¸­ã«ã€ãƒ’ãƒ«ãƒ™ãƒ«ãƒˆæ›²ç·šã®å……å¡«ç‡ã¨ Torâ‚ = 1 ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹