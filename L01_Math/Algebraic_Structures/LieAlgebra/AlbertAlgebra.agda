{-# OPTIONS --cubical --guardedness #-}

module UMIN.L01_Math.Algebraic_Structures.LieAlgebra.AlbertAlgebra where

open import Cubical.Foundations.Prelude
open import UMIN.L01_Math.Algebraic_Structures.LieAlgebra.FieldOfRationals
  using (𝕜; 𝕜-zero; 𝕜-one; _+𝕜_; _·𝕜_; -𝕜_; ratEmbed; posRat)

-- ================================================================
-- §1. 八元数（Cayley代数）𝕆 の具体的構造
-- ================================================================
-- 8次元のベクトルとしての八元数 (e₀ + e₁i + e₂j + e₃k + e₄ℓ + e₅m + e₆n + e₇o)
record 𝕆 : Type where
  constructor mk𝕆
  field
    e₀ e₁ e₂ e₃ e₄ e₅ e₆ e₇ : 𝕜

-- 零元
𝕆-zero : 𝕆
𝕆-zero = mk𝕆 𝕜-zero 𝕜-zero 𝕜-zero 𝕜-zero 𝕜-zero 𝕜-zero 𝕜-zero 𝕜-zero

-- 共役 conj(x) = e₀ - e₁i - e₂j - ... - e₇o
conj-𝕆 : 𝕆 → 𝕆
conj-𝕆 (mk𝕆 e₀ e₁ e₂ e₃ e₄ e₅ e₆ e₇) =
  mk𝕆 e₀ (-𝕜 e₁) (-𝕜 e₂) (-𝕜 e₃) (-𝕜 e₄) (-𝕜 e₅) (-𝕜 e₆) (-𝕜 e₇)

-- 加法（成分ごと）
_+𝕆_ : 𝕆 → 𝕆 → 𝕆
(mk𝕆 a₀ a₁ a₂ a₃ a₄ a₅ a₆ a₇) +𝕆 (mk𝕆 b₀ b₁ b₂ b₃ b₄ b₅ b₆ b₇) =
  mk𝕆 (a₀ +𝕜 b₀) (a₁ +𝕜 b₁) (a₂ +𝕜 b₂) (a₃ +𝕜 b₃)
      (a₄ +𝕜 b₄) (a₅ +𝕜 b₅) (a₆ +𝕜 b₆) (a₇ +𝕜 b₇)

-- 内積 ⟨x,y⟩𝕆 = Re(x·conj(y)) = e₀f₀ + e₁f₁ + ... + e₇f₇
⟨_,_⟩𝕆 : 𝕆 → 𝕆 → 𝕜
⟨ mk𝕆 a₀ a₁ a₂ a₃ a₄ a₅ a₆ a₇ , mk𝕆 b₀ b₁ b₂ b₃ b₄ b₅ b₆ b₇ ⟩𝕆 =
  (a₀ ·𝕜 b₀) +𝕜 (a₁ ·𝕜 b₁) +𝕜 (a₂ ·𝕜 b₂) +𝕜 (a₃ ·𝕜 b₃)
  +𝕜 (a₄ ·𝕜 b₄) +𝕜 (a₅ ·𝕜 b₅) +𝕜 (a₆ ·𝕜 b₆) +𝕜 (a₇ ·𝕜 b₇)

-- Fano 平面の 7 三つ組: (1,2,3),(1,4,5),(1,7,6),(2,4,6),(2,5,7),(3,4,7),(3,6,5)
-- 巡回ルール: eᵢ·eⱼ = eₖ (cyclic), eⱼ·eᵢ = -eₖ (anticyclic)
-- Wikipedia Cayley-Graves 乗法表に従う
_·𝕆_ : 𝕆 → 𝕆 → 𝕆
(mk𝕆 a₀ a₁ a₂ a₃ a₄ a₅ a₆ a₇) ·𝕆 (mk𝕆 b₀ b₁ b₂ b₃ b₄ b₅ b₆ b₇) =
  mk𝕆 r₀ r₁ r₂ r₃ r₄ r₅ r₆ r₇
  where
  -- 実部: a₀b₀ - Σ aᵢbᵢ
  r₀ = (a₀ ·𝕜 b₀) +𝕜 (-𝕜 ((a₁ ·𝕜 b₁) +𝕜 (a₂ ·𝕜 b₂) +𝕜 (a₃ ·𝕜 b₃) +𝕜 (a₄ ·𝕜 b₄) +𝕜 (a₅ ·𝕜 b₅) +𝕜 (a₆ ·𝕜 b₆) +𝕜 (a₇ ·𝕜 b₇)))
  -- e₁ 係数: a₀b₁ + a₁b₀ + a₂b₃ - a₃b₂ + a₄b₅ - a₅b₄ - a₆b₇ + a₇b₆
  r₁ = (a₀ ·𝕜 b₁) +𝕜 (a₁ ·𝕜 b₀) +𝕜 (a₂ ·𝕜 b₃) +𝕜 (-𝕜 (a₃ ·𝕜 b₂)) +𝕜 (a₄ ·𝕜 b₅) +𝕜 (-𝕜 (a₅ ·𝕜 b₄)) +𝕜 (-𝕜 (a₆ ·𝕜 b₇)) +𝕜 (a₇ ·𝕜 b₆)
  r₂ = (a₀ ·𝕜 b₂) +𝕜 (a₂ ·𝕜 b₀) +𝕜 (a₁ ·𝕜 b₃) +𝕜 (-𝕜 (a₃ ·𝕜 b₁)) +𝕜 (a₄ ·𝕜 b₆) +𝕜 (a₅ ·𝕜 b₇) +𝕜 (-𝕜 (a₆ ·𝕜 b₄)) +𝕜 (-𝕜 (a₇ ·𝕜 b₅))
  r₃ = (a₀ ·𝕜 b₃) +𝕜 (a₃ ·𝕜 b₀) +𝕜 (a₁ ·𝕜 b₂) +𝕜 (-𝕜 (a₂ ·𝕜 b₁)) +𝕜 (a₄ ·𝕜 b₇) +𝕜 (-𝕜 (a₅ ·𝕜 b₆)) +𝕜 (a₆ ·𝕜 b₅) +𝕜 (-𝕜 (a₇ ·𝕜 b₄))
  r₄ = (a₀ ·𝕜 b₄) +𝕜 (a₄ ·𝕜 b₀) +𝕜 (-𝕜 (a₁ ·𝕜 b₅)) +𝕜 (-𝕜 (a₂ ·𝕜 b₆)) +𝕜 (-𝕜 (a₃ ·𝕜 b₇)) +𝕜 (a₅ ·𝕜 b₁) +𝕜 (a₆ ·𝕜 b₂) +𝕜 (a₇ ·𝕜 b₃)
  r₅ = (a₀ ·𝕜 b₅) +𝕜 (a₅ ·𝕜 b₀) +𝕜 (a₁ ·𝕜 b₄) +𝕜 (-𝕜 (a₂ ·𝕜 b₇)) +𝕜 (a₃ ·𝕜 b₆) +𝕜 (-𝕜 (a₄ ·𝕜 b₁)) +𝕜 (-𝕜 (a₆ ·𝕜 b₃)) +𝕜 (a₇ ·𝕜 b₂)
  r₆ = (a₀ ·𝕜 b₆) +𝕜 (a₆ ·𝕜 b₀) +𝕜 (a₁ ·𝕜 b₇) +𝕜 (a₂ ·𝕜 b₄) +𝕜 (-𝕜 (a₃ ·𝕜 b₅)) +𝕜 (-𝕜 (a₄ ·𝕜 b₂)) +𝕜 (a₅ ·𝕜 b₃) +𝕜 (-𝕜 (a₇ ·𝕜 b₁))
  r₇ = (a₀ ·𝕜 b₇) +𝕜 (a₇ ·𝕜 b₀) +𝕜 (-𝕜 (a₁ ·𝕜 b₆)) +𝕜 (a₂ ·𝕜 b₅) +𝕜 (a₃ ·𝕜 b₄) +𝕜 (-𝕜 (a₄ ·𝕜 b₃)) +𝕜 (-𝕜 (a₅ ·𝕜 b₂)) +𝕜 (a₆ ·𝕜 b₁)

norm-𝕆 : 𝕆 → 𝕜
norm-𝕆 x = ⟨ x , x ⟩𝕆

-- スカラー倍（Jordan 積の calc-off で使用）
_⊛𝕆_ : 𝕜 → 𝕆 → 𝕆
k ⊛𝕆 (mk𝕆 e₀ e₁ e₂ e₃ e₄ e₅ e₆ e₇) =
  mk𝕆 (k ·𝕜 e₀) (k ·𝕜 e₁) (k ·𝕜 e₂) (k ·𝕜 e₃)
      (k ·𝕜 e₄) (k ·𝕜 e₅) (k ·𝕜 e₆) (k ·𝕜 e₇)

infixl 20 _+𝕆_
infixl 30 _·𝕆_
infixr 25 _⊛𝕆_

-- ================================================================
-- §2. Albert代数 𝔍ᶜ の Record 定義 (3x3 エルミート行列)
-- ================================================================
--  ( ξ₁  x₃  x₂* )
--  ( x₃* ξ₂  x₁  )
--  ( x₂  x₁* ξ₃  )
record 𝔍ᶜ : Type where
  constructor mk𝔍
  field
    ξ₁ ξ₂ ξ₃ : 𝕜  -- 対角成分
    x₁ x₂ x₃ : 𝕆  -- 非対角成分

-- Albert代数の単位元 E（対角 1、非対角 0）
E-𝔍 : 𝔍ᶜ
E-𝔍 = mk𝔍 𝕜-one 𝕜-one 𝕜-one 𝕆-zero 𝕆-zero 𝕆-zero

-- 𝔍ᶜ の加法・符号反転・スカラー倍
_+𝔍_ : 𝔍ᶜ → 𝔍ᶜ → 𝔍ᶜ
mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃ +𝔍 mk𝔍 η₁ η₂ η₃ y₁ y₂ y₃ =
  mk𝔍 (ξ₁ +𝕜 η₁) (ξ₂ +𝕜 η₂) (ξ₃ +𝕜 η₃) (x₁ +𝕆 y₁) (x₂ +𝕆 y₂) (x₃ +𝕆 y₃)

-𝔍_ : 𝔍ᶜ → 𝔍ᶜ
-𝔍 (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) =
  mk𝔍 (-𝕜 ξ₁) (-𝕜 ξ₂) (-𝕜 ξ₃) ((-𝕜 𝕜-one) ⊛𝕆 x₁) ((-𝕜 𝕜-one) ⊛𝕆 x₂) ((-𝕜 𝕜-one) ⊛𝕆 x₃)

_⊛𝔍_ : 𝕜 → 𝔍ᶜ → 𝔍ᶜ
k ⊛𝔍 (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) =
  mk𝔍 (k ·𝕜 ξ₁) (k ·𝕜 ξ₂) (k ·𝕜 ξ₃) (k ⊛𝕆 x₁) (k ⊛𝕆 x₂) (k ⊛𝕆 x₃)

infixl 20 _+𝔍_
infixr 25 _⊛𝔍_

-- ================================================================
-- §3. Jordan 積 X ∘ Y の定義 (source 05, 4.1節)
-- ================================================================
-- 対角成分: ξ'ᵢ = ξᵢηᵢ + (1/2)(⟨xₖ,yₖ⟩𝕆 + ⟨xₗ,yₗ⟩𝕆) （Re(x·conj(y)) の和）
calc-diag : 𝕜 → 𝕜 → 𝕆 → 𝕆 → 𝕆 → 𝕆 → 𝕜
calc-diag ξ η xa ya xb yb =
  ξ ·𝕜 η +𝕜 ratEmbed (posRat 1 2) (((⟨ xa , ya ⟩𝕆 +𝕜 ⟨ xb , yb ⟩𝕆) ·𝕜 𝕜-one))

-- 1/2 スカラー倍の補助
half : 𝕜
half = ratEmbed (posRat 1 2) 𝕜-one

-- calc-off: 論文 (source 05, 4.1 節) に基づく非対角成分
-- x' = (1/2)(ξa+ξb)y + (1/2)(ηa+ηb)x + (1/2)(xa·yb + ya·xb)
calc-off : 𝕜 → 𝕜 → 𝕜 → 𝕜 → 𝕆 → 𝕆 → 𝕆 → 𝕆 → 𝕆 → 𝕆 → 𝕆
calc-off ξa ξb ηa ηb x y xa ya xb yb =
  (half ⊛𝕆 ((ξa +𝕜 ξb) ⊛𝕆 y)) +𝕆 (half ⊛𝕆 ((ηa +𝕜 ηb) ⊛𝕆 x)) +𝕆 (half ⊛𝕆 ((xa ·𝕆 yb) +𝕆 (ya ·𝕆 xb)))

-- 行列の積 (XY + YX)/2 を成分ごとに書き下す
_∘_ : 𝔍ᶜ → 𝔍ᶜ → 𝔍ᶜ
_∘_ (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) (mk𝔍 η₁ η₂ η₃ y₁ y₂ y₃) =
  mk𝔍 ξ'₁ ξ'₂ ξ'₃ x'₁ x'₂ x'₃
  where
    ξ'₁ = calc-diag ξ₁ η₁ x₃ y₃ x₂ y₂
    ξ'₂ = calc-diag ξ₂ η₂ x₁ y₁ x₃ y₃
    ξ'₃ = calc-diag ξ₃ η₃ x₂ y₂ x₁ y₁

    -- x'₁ = (1/2)(ξ₂+ξ₃)y₁ + (1/2)(η₂+η₃)x₁ + (1/2)(x₂·y₃ + y₂·x₃)
    x'₁ = calc-off ξ₂ ξ₃ η₂ η₃ x₁ y₁ x₂ y₂ x₃ y₃
    -- x'₂ = (1/2)(ξ₃+ξ₁)y₂ + (1/2)(η₃+η₁)x₂ + (1/2)(x₃·y₁ + y₃·x₁)
    x'₂ = calc-off ξ₃ ξ₁ η₃ η₁ x₂ y₂ x₃ y₃ x₁ y₁
    -- x'₃ = (1/2)(ξ₁+ξ₂)y₃ + (1/2)(η₁+η₂)x₃ + (1/2)(x₁·y₂ + y₁·x₂)
    x'₃ = calc-off ξ₁ ξ₂ η₁ η₂ x₃ y₃ x₁ y₁ x₂ y₂

-- ================================================================
-- §4. トレース形式と内積
-- ================================================================
tr-𝔍 : 𝔍ᶜ → 𝕜
tr-𝔍 (mk𝔍 ξ₁ ξ₂ ξ₃ _ _ _) = ξ₁ +𝕜 ξ₂ +𝕜 ξ₃

-- 内積 (X, Y) = tr(X ∘ Y)
⟨_,_⟩ⱼ𝕜 : 𝔍ᶜ → 𝔍ᶜ → 𝕜
⟨ X , Y ⟩ⱼ𝕜 = tr-𝔍 (X ∘ Y)

-- ================================================================
-- §5. Jordan クロス積 X × Y (source 77, E₇ 作用の 2B×Y 等で使用)
-- ================================================================
-- X × Y = (1/2)(2 X∘Y - tr(X)Y - tr(Y)X + (tr(X)tr(Y) - tr(X∘Y))E)
_×𝔍_ : 𝔍ᶜ → 𝔍ᶜ → 𝔍ᶜ
X ×𝔍 Y = half ⊛𝔍 step4
  where
  two : 𝕜
  two = ratEmbed (posRat 2 1) 𝕜-one
  coeffE : 𝕜
  coeffE = (tr-𝔍 X ·𝕜 tr-𝔍 Y) +𝕜 (-𝕜 tr-𝔍 (X ∘ Y))
  step4 : 𝔍ᶜ
  step4 = ((two ⊛𝔍 (X ∘ Y)) +𝔍 (-𝔍 (tr-𝔍 X ⊛𝔍 Y))) +𝔍 ((-𝔍 (tr-𝔍 Y ⊛𝔍 X)) +𝔍 (coeffE ⊛𝔍 E-𝔍))

infixl 40 _×𝔍_

-- ================================================================
--  対合と複素共役の定義 (Octonion レベルの完全撃破)
-- ================================================================

-- 💥 撃破！ 八元数 𝕆 レベルの変換の完全実装
-- 八元数は実スカラーの集まりなので、共役も対合もそのまま返す（恒等写像）
τ-𝕆 : 𝕆 → 𝕆
τ-𝕆 x = x

λ-𝕆 : 𝕆 → 𝕆
λ-𝕆 x = x

-- 💥 撃破！ 𝕆 の対合の完全な証明（自明なので refl で一撃！）
τ-𝕆-inv : (x : 𝕆) → τ-𝕆 (τ-𝕆 x) ≡ x
τ-𝕆-inv x = refl

λ-𝕆-inv : (x : 𝕆) → λ-𝕆 (λ-𝕆 x) ≡ x
λ-𝕆-inv x = refl

τ-λ-𝕆-comm : (x : 𝕆) → τ-𝕆 (λ-𝕆 x) ≡ λ-𝕆 (τ-𝕆 x)
τ-λ-𝕆-comm x = refl

-- 💥 撃破！ 𝔍ᶜ 上の変換の完全実装
-- スカラー(ξ)には何もしない。八元数(x)にだけ変換を適用する！
τ-𝔍 : 𝔍ᶜ → 𝔍ᶜ
τ-𝔍 (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) = mk𝔍 ξ₁ ξ₂ ξ₃ (τ-𝕆 x₁) (τ-𝕆 x₂) (τ-𝕆 x₃)

λ-𝔍 : 𝔍ᶜ → 𝔍ᶜ
λ-𝔍 (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) = mk𝔍 ξ₁ ξ₂ ξ₃ (λ-𝕆 x₁) (λ-𝕆 x₂) (λ-𝕆 x₃)

-- 証明用ヘルパー関数: mk𝔍 の全6成分が等しければ全体も等しい
private
  cong6-mk𝔍 : ∀ {ξ₁ ξ₁' ξ₂ ξ₂' ξ₃ ξ₃' x₁ x₁' x₂ x₂' x₃ x₃'}
    → ξ₁ ≡ ξ₁' → ξ₂ ≡ ξ₂' → ξ₃ ≡ ξ₃'
    → x₁ ≡ x₁' → x₂ ≡ x₂' → x₃ ≡ x₃'
    → mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃ ≡ mk𝔍 ξ₁' ξ₂' ξ₃' x₁' x₂' x₃'
  cong6-mk𝔍 p1 p2 p3 p4 p5 p6 i = mk𝔍 (p1 i) (p2 i) (p3 i) (p4 i) (p5 i) (p6 i)

-- 💥 撃破！ 𝔍ᶜ の対合の完全な証明
-- スカラー成分は不変なので「refl」で自明に証明完了！
τ-𝔍-inv : (X : 𝔍ᶜ) → τ-𝔍 (τ-𝔍 X) ≡ X
τ-𝔍-inv (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) =
  cong6-mk𝔍 refl refl refl (τ-𝕆-inv x₁) (τ-𝕆-inv x₂) (τ-𝕆-inv x₃)

λ-𝔍-inv : (X : 𝔍ᶜ) → λ-𝔍 (λ-𝔍 X) ≡ X
λ-𝔍-inv (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) =
  cong6-mk𝔍 refl refl refl (λ-𝕆-inv x₁) (λ-𝕆-inv x₂) (λ-𝕆-inv x₃)

τ-λ-𝔍-comm : (X : 𝔍ᶜ) → τ-𝔍 (λ-𝔍 X) ≡ λ-𝔍 (τ-𝔍 X)
τ-λ-𝔍-comm (mk𝔍 ξ₁ ξ₂ ξ₃ x₁ x₂ x₃) =
  cong6-mk𝔍 refl refl refl (τ-λ-𝕆-comm x₁) (τ-λ-𝕆-comm x₂) (τ-λ-𝕆-comm x₃)